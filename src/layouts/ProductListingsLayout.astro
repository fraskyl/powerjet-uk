---
// Sidebar Navigation Layout for Product Listings
// Mobile: Expandable dropdown menu | Desktop/Tablet: Fixed sidebar with nested categories

import "../styles/global.css";
import { sanityClient } from "../lib/sanity";
import { 
  topLevelProductCategoriesQuery,
  allProductsWithCategoriesQuery,
  allProductCategoriesWithParentsQuery,
} from "../lib/queries";

import BaseLayout from "./BaseLayout.astro";
import Header from "../components/Layout/Header.astro";
import Footer from "../components/Layout/Footer.astro";
import TextHero from "../components/Sections/TextHero.astro";
import Card from "../components/UI/Card.astro";
import ContactBlock from "../components/Sections/ContactBlock.astro";
import SectionTitle from "../components/Content/SectionTitle.astro";

interface Props {
  pageType: "rental" | "sale";
  headline: string;
}

const { pageType, headline } = Astro.props;

let topLevelCategories = [];
let allProducts = [];
let allProductCategories = [];
let fetchError = false;

try {
  allProductCategories = await sanityClient.fetch(allProductCategoriesWithParentsQuery, { 
    availability: pageType 
  });
  topLevelCategories = await sanityClient.fetch(topLevelProductCategoriesQuery, {
    availability: pageType
  });
  const rawProducts = await sanityClient.fetch(allProductsWithCategoriesQuery, { 
    availability: pageType 
  });
  
  // Process products
  allProducts = rawProducts.map((product: any) => {
    let imageUrl = product.imageUrl;
    let imageAlt = product.imageAlt;
    
    if (product.images && product.images.length > 0) {
      imageUrl = product.images[0].url;
      imageAlt = product.images[0].alt;
    }
    
    const categoryPath = [];
    if (product.productCategory?.slug) {
      categoryPath.push(product.productCategory.slug);
      if (product.productCategory.parent?.slug) {
        categoryPath.push(product.productCategory.parent.slug);
        if (product.productCategory.parent.parent?.slug) {
          categoryPath.push(product.productCategory.parent.parent.slug);
        }
      }
    }
    
    return { ...product, imageUrl, imageAlt, categoryPath };
  });
  
} catch (error) {
  console.error(`‚ùå Error fetching ${pageType} products:`, error);
  fetchError = true;
}

const title = pageType === "rental" ? "Rentals | Powerjet" : "Sales | Powerjet";
---

<BaseLayout title={title}>
  <Header />
  <body>
    <div class="page-grid">
      <TextHero headline={headline} />

      {fetchError ? (
        <div class="error-message">
          <p>Unable to load products. Please try again later.</p>
        </div>
      ) : (
        <>
          <div class="product-tab__header">
            <SectionTitle headline="Browse by category" headingSize="small" />  
          </div>

          <!-- Mobile: Dropdown Menu -->
          <div class="mobile-filter-container">
            <button class="mobile-filter-toggle" id="mobile-filter-toggle">
              <span class="filter-label">
                <span class="filter-icon material-symbols-outlined">filter_list</span>
                <span id="mobile-selected-category">All Products</span>
              </span>
              <span class="dropdown-icon material-symbols-outlined">expand_more</span>
            </button>
            
            <div class="mobile-filter-menu" id="mobile-filter-menu">
              <div class="mobile-category-list">
                <button class="mobile-category-item active" data-category="all" data-level="0" data-title="All Products">
                  All Products <span class="mobile-count">({allProducts.length})</span>
                </button>

                {topLevelCategories.map((cat: any) => (
                  <div class="mobile-category-group">
                    <button 
                      class="mobile-category-item mobile-parent" 
                      data-category={cat.slug}
                      data-level="1"
                      data-title={cat.title}
                    >
                      <span class="category-text">{cat.title}</span>
                      <span class="expand-icon material-symbols-outlined">chevron_right</span>
                    </button>
                    <div class="mobile-nested-container" id={`mobile-nested-${cat.slug}`}></div>
                  </div>
                ))}
              </div>
            </div>
          </div>

          <!-- Desktop: Sidebar + Products -->
          <div class="products-layout">
            <aside class="sidebar-nav">
              <nav class="category-nav">
                <button class="category-item active" data-category="all" data-level="0">
                  <span class="category-title">All Products</span>
                  <span class="category-count">({allProducts.length})</span>
                </button>

                {topLevelCategories.map((cat: any) => (
                  <div class="category-group">
                    <button class="category-item top-level" data-category={cat.slug} data-level="1">
                      <span class="category-content">
                        <span class="category-title">{cat.title}</span>
                        <span class="category-icon material-symbols-outlined">chevron_right</span>
                      </span>
                    </button>
                    <div class="nested-categories" id={`nested-${cat.slug}`}></div>
                  </div>
                ))}
              </nav>
            </aside>

            <div class="products-main">
              <div class="products-header">
                <p class="products-count" id="visible-product-count">Showing {allProducts.length} products</p>
              </div>
              
              <div class="products-grid">
                {allProducts.map((product: any) => (
                  <div class="product-card" data-categories={JSON.stringify(product.categoryPath || [])}>
                    <Card
                      imageURL={product.imageUrl}
                      imageAlt={product.imageAlt}
                      href={`/products/${product.slug}`}
                      buttonLabel={product.title}
                      icon={true}
                      style="light"
                    />
                  </div>
                ))}
              </div>
            </div>
          </div>
        </>
      )}

      <ContactBlock />
    </div>
  </body>
  <Footer />
</BaseLayout>

<style is:global>
  /* 
  SIDEBAR NAVIGATION VISUAL HIERARCHY:
  - Level 1 (Top): Standard background
  - Level 2 (Nested): Slightly darker background (pj_blue_02)
  - Level 3 (Deeper): Even darker background (pj_blue_05)
  - Indentation increases with each level (1rem ‚Üí 2rem ‚Üí 3rem)
  */
  
  .product-tab__header { grid-column: 2 / -2; margin-bottom: 2rem; }

 .mobile-filter-container {
    grid-column: 2 / -2;
    margin-bottom: 2rem;
    position: relative;
  }
  
  .mobile-filter-toggle {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background: white;
    border: 1px solid var(--pj_blue_30);
    border-radius: 0.25rem;
    font-family: "Instrument Sans", sans-serif;
    font-size: 1rem;
    color: var(--pj_brand_blue);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .mobile-filter-toggle:hover {
    border-color: var(--pj_brand_blue);
    background-color: var(--pj_blue_05);
  }
  
  .filter-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
  }
  
  .dropdown-icon {
    font-size: 1.5rem;
    transition: transform 0.3s ease;
  }
  
  .mobile-filter-toggle.active .dropdown-icon {
    transform: rotate(180deg);
  }
  
  .mobile-filter-menu {
    position: absolute;
    top: calc(100% + 0.5rem);
    left: 0;
    right: 0;
    background: white;
    border: 1px solid var(--pj_blue_30);
    border-radius: 0.25rem;
    box-shadow: 0 4px 12px rgba(0, 51, 102, 0.1);
    max-height: 70vh;
    overflow-y: auto;
    z-index: 100;
    display: none;
  }
  
  .mobile-filter-menu.active {
    display: block;
  }
  
  .mobile-category-list {
    padding: 0.5rem 0;
  }
  
  .mobile-category-item {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    background: transparent;
    border: none;
    border-left: 3px solid transparent;
    text-align: left;
    font-family: "Instrument Sans", sans-serif;
    font-size: 0.9375rem;
    color: var(--pj_blue_80);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .mobile-category-item:hover {
    background-color: var(--pj_blue_05);
  }
  
  .mobile-category-item.active {
    background-color: var(--pj_blue_10);
    border-left-color: var(--pj_brand_blue);
    color: var(--pj_brand_blue);
    font-weight: 500;
  }
  
  .mobile-category-item.mobile-parent {
    font-weight: 500;
  }
  
  .category-text {
    flex: 1;
  }
  
  .mobile-count {
    font-size: 0.875rem;
    color: var(--pj_blue_60);
    margin-left: 0.5rem;
  }
  
  .expand-icon {
    font-size: 1.25rem;
    color: var(--pj_blue_60);
    transition: transform 0.2s ease;
  }
  
  .mobile-category-item.expanded .expand-icon {
    transform: rotate(90deg);
  }
  
  .mobile-nested-container {
    display: none;
    padding-left: 0;
    background-color: var(--pj_blue_08);
  }
  
  .mobile-nested-container.active {
    display: block;
  }
  
  .mobile-nested-item {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.625rem 1rem 0.625rem 2rem;
    background: transparent;
    border: none;
    border-left: 3px solid transparent;
    text-align: left;
    font-family: "Instrument Sans", sans-serif;
    font-size: 0.875rem;
    color: var(--pj_blue_70);
    cursor: pointer;
  }
  
  .mobile-nested-item:hover {
    background-color: var(--pj_blue_15);
  }
  
  .mobile-nested-item.active {
    background-color: var(--pj_blue_20);
    border-left-color: var(--pj_brand_blue);
    color: var(--pj_brand_blue);
    font-weight: 500;
  }
  
  /* Level 3 mobile nesting */
  .mobile-nested-container .mobile-nested-container {
    background-color: var(--pj_blue_12);
  }
  
  .mobile-nested-container .mobile-nested-item {
    padding-left: 3rem;
    font-size: 0.8125rem;
  }

  /* Desktop Layout */
  .products-layout {
    grid-column: 2 / -2;
    display: flex;
    flex-direction: column;
    gap: 2rem;
    margin-bottom: 5rem; 
  }

  .sidebar-nav { 
    display: none;
   }

  .products-main { 
    flex: 1; 
  }

  .products-header { 
    margin-bottom: 1.5rem; 
  }

  .products-count { 
    font-size: 0.9375rem; 
    color: var(--pj_blue_70); 
    margin: 0;
   }

  .products-grid { 
    grid-column: 2 / -2;
    display: grid; 
    grid-template-columns: 1fr; 
    gap: 2rem; 
    margin-bottom: 5rem;
  }

  .product-card { 
    transition: opacity 0.3s ease; 
  }

  .product-card.hidden { 
    display: none; 
  }
  
  .empty-state-dynamic {
    grid-column: 1 / -1; 
    text-align: center; 
    padding: 3rem; 
    color: var(--pj_blue_70);
    background-color: var(--pj_blue_05); 
    border-radius: 0.25rem;
  }

  @media screen and (min-width: 768px) {
    .mobile-filter-container {
      display: none;
    }
    
    .sidebar-nav {
      display: block;
      flex-shrink: 0;
      width: 280px;
      position: sticky;
      top: 2rem;
      align-self: flex-start;
      max-height: calc(100vh - 4rem);
      overflow-y: auto;
      padding-right: 1rem;
    }
    
    .products-layout {
      flex-direction: row;
      gap: 3rem;
    }

      .product-card {
      max-width: 350px; /* Prevents excessive stretching */
    }
    
      .products-grid {
       grid-template-columns: repeat(auto-fill, minmax(240px, 350px));
      justify-content: start; /* Left-align when not filling row */
    }
    
    .category-nav {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .category-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: transparent;
      border: none;
      border-left: 3px solid transparent;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: "Instrument Sans", sans-serif;
      font-size: 0.9375rem;
      color: var(--pj_blue_80);
      width: 100%;
      border-radius: 0.25rem;
    }
    
    .category-item:hover {
      background-color: var(--pj_blue_05);
      border-left-color: var(--pj_blue_30);
    }
    
    .category-item.active {
      background-color: var(--pj_blue_10);
      border-left-color: var(--pj_brand_blue);
      color: var(--pj_brand_blue);
      font-weight: 500;
    }
    
    .category-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }
    
    .category-title {
      flex: 1;
    }
    
    .category-count {
      font-size: 0.875rem;
      color: var(--pj_blue_60);
      margin-left: 0.5rem;
    }
    
    .category-icon {
      font-size: 1.25rem;
      color: var(--pj_blue_60);
      transition: transform 0.2s ease;
      margin-left: 0.5rem;
    }
    
    .category-item.expanded .category-icon {
      transform: rotate(90deg);
    }
    
    /* Nested categories container */
    .nested-categories {
      display: none;
      padding-left: 0;
      margin-top: 0;
      background-color: var(--pj_blue_02);
    }
    
    .nested-categories.active {
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    
    /* Nested category items */
    .nested-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.625rem 1rem 0.625rem 2rem;
      background: transparent;
      border: none;
      border-left: 3px solid transparent;
      text-align: left;
      font-family: "Instrument Sans", sans-serif;
      font-size: 0.875rem;
      color: var(--pj_blue_70);
      cursor: pointer;
      border-radius: 0;
      width: 100%;
    }
    
    .nested-item:hover {
      background-color: var(--pj_blue_08);
    }
    
    .nested-item.active {
      background-color: var(--pj_blue_15);
      border-left-color: var(--pj_brand_blue);
      color: var(--pj_brand_blue);
      font-weight: 500;
    }
    
    .nested-item.has-children .category-icon {
      display: inline-block;
    }
    
    /* Level 3 nesting - deeper categories */
    .nested-categories .nested-categories {
      background-color: var(--pj_blue_05);
    }
    
    .nested-categories .nested-item {
      padding-left: 3rem;
      font-size: 0.8125rem;
    }
  }

  @media screen and (min-width: 1024px) {
    .products-layout {
      gap: 4rem;
    }
    
    .sidebar-nav {
      width: 320px;
    }
    
        .products-grid {
      grid-column: 3 / -3;
      grid-template-columns: repeat(auto-fill, minmax(280px, 340px));
    }

    .product-card {
      max-width: 380px;
    }
  }
</style>
<script define:vars={{ allProducts, topLevelCategories, allProductCategories }}>
  // Category navigation data
  const categoryData = {
    products: allProducts,
    topLevel: topLevelCategories,
    allTypes: allProductCategories,
  };

  // Initial debug logging
  console.log('\nüéØ SIDEBAR NAVIGATION INITIALIZED');
  console.log('=====================================');
  console.log('Data received:');
  console.log('  - Products:', categoryData.products.length);
  console.log('  - Top-level categories:', categoryData.topLevel.length);
  console.log('  - All product types:', categoryData.allTypes.length);
  
  if (categoryData.topLevel.length > 0) {
    console.log('\nTop-level categories:');
    categoryData.topLevel.forEach(cat => {
      console.log(`  - ${cat.title} (${cat.slug})`);
    });
  }
  
  if (categoryData.products.length > 0) {
    console.log('\nSample product:');
    const sample = categoryData.products[0];
    console.log(`  Title: ${sample.title}`);
    console.log(`  Category path:`, sample.categoryPath);
  }
  console.log('=====================================\n');

  function getChildCategories(parentSlug) {
    return categoryData.allTypes
      .filter(type => type.parentSlug === parentSlug)
      .map(type => ({ slug: type.slug, title: type.title, _id: type._id, order: type.order || 0 }))
      .sort((a, b) => a.order - b.order || a.title.localeCompare(b.title));
  }

  function countProductsInCategory(categorySlug) {
    return categoryData.products.filter(product => 
      (product.categoryPath || []).includes(categorySlug)
    ).length;
  }

  function filterProducts(categorySlug) {
    console.log(`üîé Filtering products for: "${categorySlug}"`);
    
    const products = document.querySelectorAll('.product-card');
    let visibleCount = 0;
    
    products.forEach(product => {
      const categories = JSON.parse(product.getAttribute('data-categories') || '[]');
      if (categorySlug === 'all' || categories.includes(categorySlug)) {
        product.classList.remove('hidden');
        visibleCount++;
      } else {
        product.classList.add('hidden');
      }
    });
    
    console.log(`üìä Result: ${visibleCount} products visible`);
    
    // Update product count
    const countElement = document.getElementById('visible-product-count');
    if (countElement) {
      countElement.textContent = `Showing ${visibleCount} product${visibleCount !== 1 ? 's' : ''}`;
    }
    
    // Manage empty state
    const existingEmptyState = document.querySelector('.empty-state-dynamic');
    if (visibleCount === 0 && !existingEmptyState) {
      const grid = document.querySelector('.products-grid');
      const empty = document.createElement('div');
      empty.className = 'empty-state-dynamic';
      empty.innerHTML = '<p>Sorry, there are no products available in this category.</p>';
      grid.appendChild(empty);
    } else if (existingEmptyState) {
      existingEmptyState.style.display = visibleCount === 0 ? 'block' : 'none';
    }
    
    return visibleCount;
  }

  function buildNestedCategories(parentSlug, containerId) {
    const children = getChildCategories(parentSlug);
    const container = document.getElementById(containerId);
    
    if (!container || children.length === 0) {
      console.log(`  ‚ÑπÔ∏è No children to build for "${parentSlug}"`);
      return;
    }
    
    console.log(`  ‚úì Building ${children.length} nested items for "${parentSlug}"`);
    
    container.innerHTML = children.map(cat => {
      const productCount = countProductsInCategory(cat.slug);
      const hasChildren = getChildCategories(cat.slug).length > 0;
      return `
        <button class="nested-item ${hasChildren ? 'has-children' : ''}" data-category="${cat.slug}" data-level="2" data-parent="${parentSlug}">
          <span class="category-content">
            <span class="category-title">${cat.title}</span>
            ${hasChildren ? '<span class="category-icon material-symbols-outlined">chevron_right</span>' : ''}
          </span>
          <span class="category-count">(${productCount})</span>
        </button>
        ${hasChildren ? `<div class="nested-categories" id="nested-${cat.slug}"></div>` : ''}
      `;
    }).join('');
    
    // Attach click handlers to newly created nested items
    container.querySelectorAll('.nested-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const categorySlug = item.getAttribute('data-category');
        const hasChildren = item.classList.contains('has-children');
        
        console.log(`üëÜ Nested item clicked: "${categorySlug}" (hasChildren: ${hasChildren})`);
        
        // Update active states
        document.querySelectorAll('.category-item, .nested-item').forEach(el => 
          el.classList.remove('active')
        );
        item.classList.add('active');
        
        // Filter products
        filterProducts(categorySlug);
        
        // Handle expansion if has children
        if (hasChildren) {
          const wasExpanded = item.classList.contains('expanded');
          
          // Close other nested menus at same level
          const parent = item.closest('.nested-categories');
          if (parent) {
            parent.querySelectorAll('.nested-item.expanded').forEach(el => {
              if (el !== item) {
                el.classList.remove('expanded');
                const nestedId = `nested-${el.getAttribute('data-category')}`;
                const nestedEl = document.getElementById(nestedId);
                if (nestedEl) nestedEl.classList.remove('active');
              }
            });
          }
          
          // Toggle this item's expansion
          item.classList.toggle('expanded');
          const nested = document.getElementById(`nested-${categorySlug}`);
          
          if (nested) {
            nested.classList.toggle('active');
            
            // Build deeper nested menu if needed
            if (nested.classList.contains('active') && nested.children.length === 0) {
              console.log(`  ‚Üí Building deeper nested categories for "${categorySlug}"`);
              buildNestedCategories(categorySlug, `nested-${categorySlug}`);
            }
          }
        }
      });
    });
  }

  function buildMobileNestedCategories(parentSlug, containerId) {
    const children = getChildCategories(parentSlug);
    const container = document.getElementById(containerId);
    
    if (!container || children.length === 0) {
      console.log(`  ‚ÑπÔ∏è No mobile children to build for "${parentSlug}"`);
      return;
    }
    
    console.log(`  ‚úì Building ${children.length} mobile nested items for "${parentSlug}"`);
    
    container.innerHTML = children.map(cat => {
      const productCount = countProductsInCategory(cat.slug);
      const hasChildren = getChildCategories(cat.slug).length > 0;
      return `
        <button class="mobile-nested-item ${hasChildren ? 'has-children' : ''}" data-category="${cat.slug}" data-title="${cat.title}" data-parent="${parentSlug}">
          <span class="category-text">${cat.title}</span>
          <span class="mobile-count">(${productCount})</span>
          ${hasChildren ? '<span class="expand-icon material-symbols-outlined">chevron_right</span>' : ''}
        </button>
        ${hasChildren ? `<div class="mobile-nested-container" id="mobile-nested-${cat.slug}"></div>` : ''}
      `;
    }).join('');
    
    // Attach click handlers to newly created mobile nested items
    container.querySelectorAll('.mobile-nested-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.stopPropagation();
        
        const categorySlug = item.getAttribute('data-category');
        const categoryTitle = item.getAttribute('data-title');
        const hasChildren = item.classList.contains('has-children');
        
        console.log(`üëÜ Mobile nested item clicked: "${categorySlug}" (hasChildren: ${hasChildren})`);
        
        if (hasChildren) {
          // Has children - toggle expansion
          item.classList.toggle('expanded');
          const nested = document.getElementById(`mobile-nested-${categorySlug}`);
          
          if (nested) {
            nested.classList.toggle('active');
            
            // Build deeper nested menu if needed
            if (nested.classList.contains('active') && nested.children.length === 0) {
              buildMobileNestedCategories(categorySlug, `mobile-nested-${categorySlug}`);
            }
          }
        } else {
          // No children - select this category
          const toggle = document.getElementById('mobile-filter-toggle');
          const menu = document.getElementById('mobile-filter-menu');
          selectMobileCategory(item, categorySlug, categoryTitle, menu, toggle);
        }
      });
    });
  }

  function initDesktopSidebar() {
    const categoryItems = document.querySelectorAll('.sidebar-nav .category-item');
    
    if (categoryItems.length === 0) {
      console.warn('‚ö†Ô∏è No desktop category items found');
      return;
    }
    
    console.log(`‚úÖ Initializing ${categoryItems.length} desktop category items`);
    
    categoryItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const categorySlug = item.getAttribute('data-category');
        const level = item.getAttribute('data-level');
        
        console.log(`üëÜ Desktop category clicked: "${categorySlug}" (level: ${level})`);
        
        // Update active states - remove from all items
        categoryItems.forEach(el => el.classList.remove('active'));
        item.classList.add('active');
        
        // Clear nested active states
        document.querySelectorAll('.nested-item').forEach(el => 
          el.classList.remove('active')
        );
        
        if (categorySlug === 'all') {
          console.log('  ‚Üí Showing all products');
          
          // Hide all nested menus and remove expanded states
          document.querySelectorAll('.nested-categories').forEach(el => 
            el.classList.remove('active')
          );
          document.querySelectorAll('.category-item.expanded').forEach(el => 
            el.classList.remove('expanded')
          );
          
          // Filter to show all products
          filterProducts('all');
        } else {
          // Check for children
          const children = getChildCategories(categorySlug);
          const nested = document.getElementById(`nested-${categorySlug}`);
          
          console.log(`  ‚Üí Found ${children.length} children for "${categorySlug}"`);
          
          if (children.length > 0 && nested) {
            // Has children - toggle expansion
            const wasExpanded = item.classList.contains('expanded');
            
            // Close all other nested menus
            document.querySelectorAll('.nested-categories').forEach(el => {
              if (el.id !== `nested-${categorySlug}`) {
                el.classList.remove('active');
              }
            });
            document.querySelectorAll('.category-item.expanded').forEach(el => {
              if (el !== item) {
                el.classList.remove('expanded');
              }
            });
            
            // Toggle this menu
            item.classList.toggle('expanded');
            nested.classList.toggle('active');
            
            console.log(`  ‚Üí ${wasExpanded ? 'Closing' : 'Opening'} nested menu`);
            
            // Build nested menu if not already built
            if (nested.classList.contains('active') && nested.children.length === 0) {
              console.log('  ‚Üí Building nested categories');
              buildNestedCategories(categorySlug, `nested-${categorySlug}`);
            }
          } else {
            console.log('  ‚Üí No children, closing other menus');
            
            // No children - close all nested menus
            document.querySelectorAll('.nested-categories').forEach(el => 
              el.classList.remove('active')
            );
            document.querySelectorAll('.category-item.expanded').forEach(el => 
              el.classList.remove('expanded')
            );
          }
          
          // Filter products for this category
          filterProducts(categorySlug);
        }
      });
    });
  }

  function initMobileDropdown() {
    const toggle = document.getElementById('mobile-filter-toggle');
    const menu = document.getElementById('mobile-filter-menu');
    
    if (!toggle || !menu) {
      console.warn('‚ö†Ô∏è Mobile dropdown elements not found');
      return;
    }
    
    console.log('‚úÖ Initializing mobile dropdown');
    
    // Toggle menu
    toggle.addEventListener('click', (e) => {
      e.stopPropagation();
      console.log('üëÜ Mobile toggle clicked');
      toggle.classList.toggle('active');
      menu.classList.toggle('active');
    });
    
    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      const target = e.target;
      if (!toggle.contains(target) && !menu.contains(target)) {
        menu.classList.remove('active');
        toggle.classList.remove('active');
      }
    });
    
    // Handle category clicks
    document.querySelectorAll('.mobile-category-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.stopPropagation();
        const categorySlug = item.getAttribute('data-category');
        const categoryTitle = item.getAttribute('data-title');
        const isParent = item.classList.contains('mobile-parent');
        
        console.log(`üëÜ Mobile category clicked: "${categorySlug}" (isParent: ${isParent})`);
        
        if (isParent) {
          // Parent category - check if it has children
          const children = getChildCategories(categorySlug);
          const nested = document.getElementById(`mobile-nested-${categorySlug}`);
          
          if (children.length > 0 && nested) {
            // Has children - toggle expansion
            item.classList.toggle('expanded');
            nested.classList.toggle('active');
            
            // Build nested menu if not already built
            if (nested.classList.contains('active') && !nested.children.length) {
              buildMobileNestedCategories(categorySlug, `mobile-nested-${categorySlug}`);
            }
          } else {
            // No children - select this category
            selectMobileCategory(item, categorySlug, categoryTitle, menu, toggle);
          }
        } else {
          // Regular category - select it
          selectMobileCategory(item, categorySlug, categoryTitle, menu, toggle);
        }
      });
    });
  }
  
  function selectMobileCategory(item, categorySlug, categoryTitle, menu, toggle) {
    console.log(`‚úÖ Selecting mobile category: "${categoryTitle}"`);
    
    // Update active states
    document.querySelectorAll('.mobile-category-item, .mobile-nested-item').forEach(el => 
      el.classList.remove('active')
    );
    item.classList.add('active');
    
    // Update display
    const selectedElement = document.getElementById('mobile-selected-category');
    if (selectedElement) {
      selectedElement.textContent = categoryTitle;
    }
    
    // Close menu
    menu.classList.remove('active');
    toggle.classList.remove('active');
    
    // Filter products
    filterProducts(categorySlug);
  }

  function init() {
    console.log('\nüöÄ Initializing sidebar navigation...');
    console.log('  Products:', categoryData.products.length);
    console.log('  Top-level categories:', categoryData.topLevel.length);
    console.log('  All types:', categoryData.allTypes.length);
    
    // Check if we're on mobile or desktop
    const isMobile = window.innerWidth < 768;
    console.log(`  Device: ${isMobile ? 'Mobile' : 'Desktop/Tablet'}`);
    
    // Initialize appropriate navigation
      initMobileDropdown();
      initDesktopSidebar();
    
    // Re-initialize on window resize (debounced)
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        const wasMobile = isMobile;
        const nowMobile = window.innerWidth < 768;
        
        if (wasMobile !== nowMobile) {
          console.log('üì± Device changed, re-initializing...');
          init();
        }
      }, 250);
    });
    
    console.log('‚úÖ Sidebar navigation initialized\n');
  }

  document.addEventListener('DOMContentLoaded', init);
  document.addEventListener('astro:page-load', init);
</script>