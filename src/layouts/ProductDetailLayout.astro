---
import "../styles/global.css";
import Footer from "../components/Layout/Footer.astro";
import Header from "../components/Layout/Header.astro";
import ContactBlock from "../components/Sections/ContactBlock.astro";
import Card from "../components/UI/Card.astro";
import PerformanceTable from "../components/Product/PerformanceTable.astro";
import EngineData from "../components/Product/EngineData.astro";
import BuildOptions from "../components/Product/BuildOptions.astro";
import PhysicalSpecs from "../components/Product/PhysicalSpecs.astro";
import BaseLayout from "./BaseLayout.astro";
import ProductHero from "../components/Product/ProductHero.astro";
import RichText from "../components/Content/RichText.astro";
import SectionTitle from "../components/Content/SectionTitle.astro";


interface ContentBlock {
    _id: string;
    _type: string;
    title: string;
    content: any;
}

interface SpecItem {
    label: string;
    value: string;
}

interface SpecsListBlock {
    _type: 'specsListBlock';
    _id: string;
    title: string;
    specs: SpecItem[];
}

// Union type fro all block types
type BlockType = ContentBlock | SpecsListBlock;

interface Props {
    title: string;
    product: {
        // Basic Information
        title: string;
        slug: string;
        lede?: string;
        description?: any;
        imageUrl: string;
        imageAlt: string;
        images?: Array<{
            url: string;
            alt: string;
            caption?: string;
        }>;
        hasDatasheet?: boolean;
        datasheetUrl?: string;
        datasheetFileName?: string;

        contentBlocks?: BlockType[];

        // Categorization
        availability?: string[];
        productCategory?: {
            title: string;
            slug: string;
        };

       

        // Performance Table (Optional)
        hasPerformanceTable?: boolean;
        performanceSpecs?: Array<{
            model?: string;
            plungerSize?: string;
            psi?: string;
            bar?: string;
            lpm?: string;
            gpm?: string;
            kw?: string;
            hp?: string;
        }>;

        // Physical Characteristics (Optional)
        hasPhysicalSpecs?: boolean;
        physicalSpecs?: {
            dimensions?: string;
            weightDry?: string;
            weightWet?: string;
            waterTankCapacity?: string;
            fuelTankCapacity?: string;
            adBlueCapacity?: string;
            soundAttenuation?: string;
        };

        // Engine Data (Optional)
        hasEngineData?: boolean;
        engineData?: {
            manufacturer?: string;
            model?: string;
            ratings?: string;
            emissionCompliancy?: string;
            fuelConsumption?: string;
            adblueConsumption?: string;
        };

        // Build Options (Optional)
        hasBuildOptions?: boolean;
        buildOptions?: Array<{
            code?: string;
            description?: string;
        }>;

        // Additional
        order?: number;

        // Related Products (Optional)
        relatedProducts?: Array<{
            title: string;
            slug: string;
            imageUrl: string;
            imageAlt: string;
        }>;
    };
}

const { product } = Astro.props;

// Handle both new images array and legacy single image
let productImages = product?.images || [];
if (productImages.length === 0 && product?.imageUrl) {
    // Backwards compatibility: convert single image to array
    productImages = [{
        url: product.imageUrl,
        alt: product.imageAlt || product.title
    }];
}

// Provide fallback values for development
const productTitle = product?.title || "Product";
const productLede = product?.lede || "";
const productDescription = product?.description || null;
const productImageUrl = product?.imageUrl || "";
const productImageAlt = product?.imageAlt || "Product image";

const contentBlocks = product?.contentBlocks || [];
const relatedProducts = product?.relatedProducts || [];
---

<BaseLayout>
    <Header />
    <body>
        <div class="page-grid">
            <div class="link__prev-page-wrapper">
                <a href="/rentals">
                    <div class="link__prev-page">
                        <span class="material-symbols-outlined">arrow_back</span
                        >
                        <p>Back to all products</p>
                    </div>
                </a>
            </div>

            <ProductHero
                title={productTitle}
                lede={productLede}
                description={productDescription}
                images={productImages}
                imageUrl={productImageUrl}
                imageAlt={productImageAlt || product.title}
                hasDatasheet={product.hasDatasheet}
                datasheetUrl={product.datasheetUrl}
                datasheetFileName={product.datasheetFileName}
            />

{/* CONTENT BLOCKS - Smart Layout for Specs Lists */}

{contentBlocks.length > 0 && (
    <>
        <div class="divider__border"></div>
        
        {(() => {
            const processed = []
            
            return contentBlocks.map((block, index) => {
                // Skip if already processed
                if (processed.includes(index)) {
                    return null
                }
                
                processed.push(index)
                
                // SPECS LIST BLOCK
                if (block._type === 'specsListBlock') {
                    const nextBlock = contentBlocks[index + 1]
                    const nextIsSpecsList = nextBlock?._type === 'specsListBlock'
                    
                    // Pair with next
                    if (nextIsSpecsList) {
                        processed.push(index + 1) // Mark next as processed
                        
                        return (
                            <>
                                <section class="section__product-detail-additional-specs-wrapper">
                                    <div class="section__product-detail-physical-specs">
                                    <div class="divider__border"></div>
                                        <div class="section__product-detail-physical-specs-title">
                                              <h2>{block.title}</h2>
                                        </div>
                                        <div class="section__product-detail-physical-specs-content">
                                            {block.specs?.map((spec: SpecItem) => (
                                                <div class="spec-item">
                                                    <span class="spec-label">{spec.label}</span>
                                                    <span class="spec-value">{spec.value}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    <div class="section__product-detail-engine-specs">
                                    <div class="divider__border"></div>

                                        <div class="section__product-detail-engine-specs-title">
                                             <h2>{block.title}</h2>  
                                        </div>
                                        <div class="section__product-detail-engine-specs-content">
                                            {(nextBlock as SpecsListBlock).specs?.map((spec: SpecItem) => (
                                                <div class="spec-item">
                                                    <span class="spec-label">{spec.label}</span>
                                                    <span class="spec-value">{spec.value}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </section>
                            </>
                        )
                    }
                    
                    // Single
                    return (
                        <>
                            {index > 0 && <div class="divider__border"></div>}
                            <section class="section__product-single-specs">
                                <div class="section__product-single-specs-title">
                                    <h2>{block.title}</h2>
                                </div>
                                <div class="section__product-single-specs-content">
                                    {block.specs?.map((spec: SpecItem) => (
                                        <div class="spec-item">
                                            <span class="spec-label">{spec.label}</span>
                                            <span class="spec-value">{spec.value}</span>
                                        </div>
                                    ))}
                                </div>
                            </section>
                        </>
                    )
                }
                
                // TEXT CONTENT BLOCK
                if (block._type === 'contentBlock') {
                    return (
                        <>
                            {index > 0 && <div class="divider__border"></div>}
                            <section class="section__product-custom-content">
                                <div class="section__product-custom-content-title">
                                    <h2>{block.title}</h2>
                                </div>
                                <div class="section__product-custom-content-body">
                                    <RichText value={block.content} />
                                </div>
                            </section>
                        </>
                    )
                }
                
                return null
            })
        })()}
    </>
)}

           <!-- Performance Table Section - Renders conditionally based on hasPerformanceTable 
            {product.hasPerformanceTable && product.performanceSpecs && (
            <div class="divider__border"></div>
                <section class="section__product-performance-table">
                 
                    <div class="section__product-performance-table-content">
                        <PerformanceTable
                            headers={[
                                "Model",
                                "Plunger Size",
                                "PSI",
                                "BAR",
                                "L/min",
                                "GPM",
                                "kW",
                                "HP",
                            ]}
                            rows={product.performanceSpecs.map((spec) => ({
                                cells: [
                                    spec.model || '-',
                                    spec.plungerSize || '-',
                                    spec.psi || '-',
                                    spec.bar || '-',
                                    spec.lpm || '-',
                                    spec.gpm || '-',
                                    spec.kw || '-',
                                    spec.hp || '-'
                                ]
                            }))}
                        />
                    </div>
                </section>
            )}
     

        <section class="section__product-detail-additional-specs-wrapper">

            {product.hasPhysicalSpecs && product.physicalSpecs && (
                <div class="section__product-detail-physical-specs">
                <div class="divider__border"></div>
                <PhysicalSpecs physicalSpecs={product.physicalSpecs} />
                </div> 
           )}

            {product.hasEngineData && product.engineData && (
                <div class="section__product-detail-engine-specs">
                    <div class="divider__border"></div>
                    <EngineData engineData={product.engineData} />
                </div>
            )}
        </section>

        {product.hasBuildOptions && product.buildOptions && (
            <>
                <div class="divider__border"></div>
                <BuildOptions options={product.buildOptions} />
            </>
        )}

-->


{
                relatedProducts.length > 0 && (
                <div class="divider__border"></div>
                    <section class="section__product-detail-related-products">
                        <div class="section__product-detail-related-products-title">
                            <h2>Related Products</h2>
                        </div>
                        <div class="section__product-detail-related-products-cards">
                        {relatedProducts.map((product: any) => (
                            <Card
                                imageURL={product.imageUrl}
                                imageAlt={product.imageAlt}
                                href={`/products/${product.slug}`}
                                buttonLabel={product.title}
                                icon={true}
                                style="light"
                            />
                        ))}
                    </div>
                 
                    </section>
                )
            }

        <ContactBlock />
           </div>

    </body>
</BaseLayout>

<Footer />

<style>
/* ═══════════════════════════════════════════════════════════ */
/* Specs List Blocks - Matches your existing component styling */
/* ═══════════════════════════════════════════════════════════ */

/* Single specs block (full width) */
.section__product-single-specs {
    display: flex;
    flex-direction: column;
    grid-column: 2 / -2;
    margin-bottom: 5rem;
}

.section__product-single-specs-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

/* Spec item (label/value pair) */
.spec-item {
    display: flex;
    flex-direction: row;
    width: 100%;
    height: auto;
    font-size: 0.875rem;
    gap: 1rem;
    justify-content: space-between;
}

.spec-label {
    font-weight: 550;
}

.spec-value {
    font-weight: normal;
    text-align: right;
}

/* Desktop: single specs block */
@media screen and (min-width: 1024px) {
    .section__product-single-specs {
        grid-column: 3 / -3;
    }
}








    .link__prev-page-wrapper {
        grid-column: 2 / -2; /* ✅ Added: Position in grid */
        display: flex;
        margin-bottom: 3rem;
        margin-top: 3rem;
    }

    .link__prev-page-wrapper a {
        text-decoration: none;
        color: var(--pj_brand_blue);
    }

    .link__prev-page {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 0.5rem;
    }

    .section__product-wrapper {
        grid-column: 2 / -2; /* Span the content columns of page grid */
        display: flex;
        flex-direction: column;
        flex-flow: column-reverse;
        margin-bottom: 3rem;
        gap: 1rem;
    }

    .section__product-overview {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .section__product-cta-buttons {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .section__product-detail-image {
        display: flex;
        margin-bottom: 1rem;
    }

    .section__product-detail-image img {
        display: block;
        width: 100%;
        height: auto;
        grid-column: 2 / 1;
        border-radius: 0.25rem;
        max-height: 400px;
        object-fit: cover;
    }

    /* Custom Content Blocks */
.section__product-custom-content {
    display: flex;
    flex-direction: column;
    grid-column: 2 / -2;
    margin-bottom: 5rem;
}

.section__product-custom-content-title h2 {
    font-size: 1.5rem;
    font-weight: 450;
    color: var(--pj_blue_80);
    margin-bottom: 2rem;
}

.section__product-single-specs-title h2 {
    font-size: 1.5rem;
    font-weight: 450;
    color: var(--pj_blue_80);
    margin-bottom: 2rem;
}

.section__product-detail-physical-specs-title h2 {
    font-size: 1.5rem;
    font-weight: 450;
    color: var(--pj_blue_80);
    margin-bottom: 2rem;
}

.section__product-detail-engine-specs-title h2 {
    font-size: 1.5rem;
    font-weight: 450;
    color: var(--pj_blue_80);
    margin-bottom: 2rem;
}


.section__product-custom-content-body {
    max-width: 65ch;
    line-height: 1.6;
}

    .section__product-performance-table {
        display: flex;
        flex-direction: column;
        grid-column: 2 / -2;
        margin-bottom: 5rem;
    }

    .section__product-detail-additional-specs-wrapper {
        display: grid;
        grid-template-columns: 1fr; /* Single column on mobile */
        grid-column: 2 / -2;
        gap: 6rem;
        margin-bottom: 5rem;
    }

    .section__product-detail-physical-specs,
    .section__product-detail-engine-specs {
        display: flex;
        flex-direction: column;
    }

    .section__product-detail-physical-specs-content,
    .section__product-detail-engine-specs-content {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .section__product-detail-related-products {
        display: flex;
        flex-direction: column;
        grid-column: 2 / -2;
        margin-bottom: 7.75rem;
    }

    .section__product-detail-build-options {
        display: grid;
        grid-column: 2 / -2;
        margin-bottom: 6rem;
    }

    .section__product-detail-related-products-title h2 {
    font-size: 1.5rem;
    font-weight: 450;
    color: var(--pj_blue_80);
    margin-bottom: 2rem;
  }


    .section__product-detail-related-products-cards {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
    }

    .divider__border {
        margin-bottom: 1rem;
        height: 100%;
    }

    @media screen and (min-width: 768px) {
        .link__prev-page-wrapper {
            display: flex;
            height: 100%;
            margin-bottom: 3rem;
            margin-top: 3rem;
            grid-column: 2 / -2;
        }

        .divider__border {
            grid-column: 2 /-2;
        }

        .section__product-wrapper {
            display: flex;
            flex-direction: column;
            flex-flow: column-reverse;
            grid-column: 2 / -2;
            margin-bottom: 8rem;
        }

        .section__applications-details {
            display: flex;
            flex: 1;
        }

        .section__applications-image {
            display: flex;
            flex: 1;
        }

        .section__product-performance-table {
            display: grid;
            grid-column: 2 / -2;
            margin-bottom: 6rem;
        }

        .section__product-detail-additional-specs-wrapper {
            grid-column: 2 / -2;
            grid-template-columns: 1fr 1fr; /* Two equal columns */
            gap: 6rem;
            align-items: start;;
        }

        .section__product-detail-build-options {
            display: grid;
            grid-column: 2 / -2;
        }

        .section__applications-recommended-products {
            display: grid;
            grid-template-columns: 1fr;
            grid-column: 2 / -2;
            margin-bottom: 6rem;
            gap: 1rem;
        }

        .section__product-detail-related-products-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 320px));
            justify-content: start;
            gap: 1.5rem;
            grid-column: 2 / -2;
            margin-bottom: 4rem;
        }
    }
    @media screen and (min-width: 1024px) {
        .link__prev-page-wrapper {
            grid-column: 3 / -3;
            margin-bottom: 5rem;
        }

        .section__product-wrapper {
            display: flex;
            flex-direction: row;
            grid-column: 3 / -3;
            gap: 4rem;
        }

        .product-title {
            display: flex;
            flex-direction: row;
            grid-column: 3 / -3;
        }

        .divider__border {
            grid-column: 3 /-3;
        }

         .section__product-custom-content {
        grid-column: 3 / -3;
         }

        .section__product-performance-table {
            display: grid;
            grid-column: 3 / -3;
        }

        .section__product-detail-related-products {
            display: grid;
            grid-column: 3 / -3;
        }

        .section__product-detail-additional-specs-wrapper {
            grid-template-columns: 1fr 1fr; /* Two equal columns */
            grid-column: 3 / -3;
            gap: 8rem;
            margin-bottom: 6rem;
        }

        .section__product-detail-build-options {
            display: grid;
            grid-column: 3 / -3;
        }
    }
</style>
