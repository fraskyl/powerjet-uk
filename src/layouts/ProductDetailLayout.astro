---
import "../styles/global.css";
import Footer from "../components/Layout/Footer.astro";
import Header from "../components/Layout/Header.astro";
import ContactBlock from "../components/Sections/ContactBlock.astro";
import Card from "../components/UI/Card.astro";
import PerformanceTable from "../components/Product/PerformanceTable.astro";
import EngineData from "../components/Product/EngineData.astro";
import BuildOptions from "../components/Product/BuildOptions.astro";
import PhysicalSpecs from "../components/Product/PhysicalSpecs.astro";
import BaseLayout from "./BaseLayout.astro";
import ProductHero from "../components/Product/ProductHero.astro";
import RichText from "../components/Content/RichText.astro";

interface Props {
    title: string;
    product: {
        // Basic Information
        title: string;
        slug: string;
        lede?: string;
        description?: any;
        imageUrl: string;
        imageAlt: string;
        images?: Array<{
            url: string;
            alt: string;
            caption?: string;
        }>;
        hasDatasheet?: boolean;
        datasheetUrl?: string;
        datasheetFileName?: string;

        // Categorization
        availability?: string[];
        productCategory?: {
            title: string;
            slug: string;
        };
       
         // Composable Content Blocks
        contentBlocks?: Array<{
            _type: string;
            _key: string;
            [key: string]: any;
        }>;


        // Legacy support - will be removed eventually
        hasPerformanceTable?: boolean;
        performanceSpecs?: any[];
        hasPhysicalSpecs?: boolean;
        physicalSpecs?: any;
        hasEngineData?: boolean;
        engineData?: any;
        hasBuildOptions?: boolean;
        buildOptions?: any[];


        // Additional
        order?: number;

        // Related Products (Optional)
        relatedProducts?: Array<{
            title: string;
            slug: string;
            imageUrl: string;
            imageAlt: string;
        }>;
    };
}

const { title, product } = Astro.props;

// Handle both new images array and legacy single image
let productImages = product?.images || [];
if (productImages.length === 0 && product?.imageUrl) {
    // Backwards compatibility: convert single image to array
    productImages = [{
        url: product.imageUrl,
        alt: product.imageAlt || product.title
    }];
}

// Provide fallback values for development
const productTitle = product?.title || "Product";
const productLede = product?.lede || "";
const productDescription = product?.description || null;
const contentBlocks = product?.contentBlocks || [];
const productImageUrl = product?.imageUrl || "";
const productImageAlt = product?.imageAlt || "Product image";
const relatedProducts = product?.relatedProducts || [];

// Helper function to transform flexible performance table to component format
function transformPerformanceTable(block: any) {
    if (!block?.columnHeaders || !block?.rows) return null;
    
    // Extract column labels for headers
    const headers = block.columnHeaders.map((col: any) => col.label);
    
    // Transform rows - extract just the values in order
    const rows = block.rows.map((row: any) => ({
        cells: row.cells?.map((cell: any) => cell.value || '-') || []
    }));
    
    return { headers, rows };
}

// Helper function to transform specs block to component format
function transformSpecsToComponentFormat(specs: any[]) {
    if (!specs || specs.length === 0) return null;
    
    // Convert array of {label, value} to object format your components expect
    return specs.reduce((acc: any, spec: any) => {
        // Create a key from the label (lowercase, replace spaces with underscores)
        const key = spec.label.toLowerCase().replace(/\s+/g, '_').replace(/[()]/g, '');
        acc[key] = spec.value;
        return acc;
    }, {});
}
---

<BaseLayout>
    <Header />
    <body>
        <div class="page-grid">
            <div class="link__prev-page-wrapper">
                <a href="/rentals">
                    <div class="link__prev-page">
                        <span class="material-symbols-outlined">arrow_back</span
                        >
                        <p>Back to all products</p>
                    </div>
                </a>
            </div>

            <ProductHero
                title={productTitle}
                lede={productLede}
                description={productDescription}
                images={productImages}
                imageUrl={productImageUrl}
                imageAlt={productImageAlt || product.title}
                hasDatasheet={product.hasDatasheet}
                datasheetUrl={product.datasheetUrl}
                datasheetFileName={product.datasheetFileName}
            />


             {/* Render composable content blocks if they exist */}
            {contentBlocks.length > 0 ? (
                <>
                    {contentBlocks.map((block, index) => {
                        const isLastBlock = index === contentBlocks.length - 1;
                        
                        return (
                            <>
                                {/* Performance Table Block */}
                                {block._type === 'performanceTableBlock' && block.columnHeaders && block.rows && (
                                    <>
                                        <div class="divider__border"></div>
                                        <section class="section__product-performance-table">
                                            <div class="section__product-performance-table-content">
                                                <PerformanceTable
                                                    headers={transformPerformanceTable(block)?.headers || []}
                                                    rows={transformPerformanceTable(block)?.rows || []}
                                                />
                                            </div>
                                        </section>
                                    </>
                                )}

                                {/* Physical Specs and Engine Specs - Group them together if both present */}
                                {(block._type === 'physicalSpecsBlock' || block._type === 'engineSpecsBlock') && (
                                    <>
                                        {/* Check if this is the first specs block in a potential pair */}
                                        {(() => {
                                            const currentIndex = index;
                                            const nextBlock = contentBlocks[currentIndex + 1];
                                            const isPhysicalFirst = block._type === 'physicalSpecsBlock';
                                            const hasAdjacentEngineBlock = nextBlock?._type === 'engineSpecsBlock' && isPhysicalFirst;
                                            const isEngineAlone = block._type === 'engineSpecsBlock' && contentBlocks[currentIndex - 1]?._type !== 'physicalSpecsBlock';
                                            
                                            // Only render the wrapper if this is physical (with or without engine following) or engine alone
                                            if (isPhysicalFirst || isEngineAlone) {
                                                return (
                                                    <section class="section__product-detail-additional-specs-wrapper">
                                                        {/* Physical Specs */}
                                                        {block._type === 'physicalSpecsBlock' && block.specs && (
                                                            <div class="section__product-detail-physical-specs">
                                                                <div class="divider__border"></div>
                                                                <PhysicalSpecs 
                                                                    physicalSpecs={transformSpecsToComponentFormat(block.specs)} 
                                                                />
                                                            </div>
                                                        )}
                                                        
                                                        {/* Engine Specs - render if it's the adjacent block */}
                                                        {hasAdjacentEngineBlock && nextBlock.specs && (
                                                            <div class="section__product-detail-engine-specs">
                                                                <div class="divider__border"></div>
                                                                <EngineData 
                                                                    engineData={transformSpecsToComponentFormat(nextBlock.specs)} 
                                                                />
                                                            </div>
                                                        )}
                                                        
                                                        {/* Engine Specs alone */}
                                                        {isEngineAlone && block.specs && (
                                                            <div class="section__product-detail-engine-specs">
                                                                <div class="divider__border"></div>
                                                                <EngineData 
                                                                    engineData={transformSpecsToComponentFormat(block.specs)} 
                                                                />
                                                            </div>
                                                        )}
                                                    </section>
                                                );
                                            }
                                            return null;
                                        })()}
                                    </>
                                )}

                                {/* Build Options Block */}
                                {block._type === 'buildOptionsBlock' && block.options && (
                                    <>
                                        <div class="divider__border"></div>
                                        <BuildOptions options={block.options} />
                                    </>
                                )}

                                {/* Custom Content Block */}
                                {block._type === 'customContentBlock' && block.content && (
                                    <>
                                        <div class="divider__border"></div>
                                        <section class="section__product-detail-custom-content">
                                            <div class="section__product-detail-custom-content-title">
                                                <h2>{block.sectionTitle}</h2>
                                            </div>
                                            <div class="section__product-detail-custom-content-body">
                                                <RichText value={block.content} />
                                            </div>
                                        </section>
                                    </>
                                )}

                                {/* Key Specs Block - render as physical specs format */}
                                {block._type === 'keySpecsBlock' && block.specs && (
                                    <>
                                        <div class="divider__border"></div>
                                        <section class="section__product-detail-additional-specs-wrapper">
                                            <div class="section__product-detail-physical-specs">
                                                <PhysicalSpecs 
                                                    physicalSpecs={transformSpecsToComponentFormat(block.specs)} 
                                                />
                                            </div>
                                        </section>
                                    </>
                                )}
                            </>
                        );
                    })}
                </>
            ) : (
                /* Legacy support - render old structure if no content blocks */
                <>
                    {/* Performance Table Section - Legacy */}
                    {product.hasPerformanceTable && product.performanceSpecs && (
                        <>
                            <div class="divider__border"></div>
                            <section class="section__product-performance-table">
                                <div class="section__product-performance-table-content">
                                    <PerformanceTable
                                        headers={[
                                            "Model",
                                            "Plunger Size",
                                            "PSI",
                                            "BAR",
                                            "L/min",
                                            "GPM",
                                            "kW",
                                            "HP",
                                        ]}
                                        rows={product.performanceSpecs.map((spec) => ({
                                            cells: [
                                                spec.model || '-',
                                                spec.plungerSize || '-',
                                                spec.psi || '-',
                                                spec.bar || '-',
                                                spec.lpm || '-',
                                                spec.gpm || '-',
                                                spec.kw || '-',
                                                spec.hp || '-'
                                            ]
                                        }))}
                                    />
                                </div>
                            </section>
                        </>
                    )}

                    {/* Legacy Specs Section */}
                    <section class="section__product-detail-additional-specs-wrapper">
                        {product.hasPhysicalSpecs && product.physicalSpecs && (
                            <div class="section__product-detail-physical-specs">
                                <div class="divider__border"></div>
                                <PhysicalSpecs physicalSpecs={product.physicalSpecs} />
                            </div>
                        )}

                        {product.hasEngineData && product.engineData && (
                            <div class="section__product-detail-engine-specs">
                                <div class="divider__border"></div>
                                <EngineData engineData={product.engineData} />
                            </div>
                        )}
                    </section>

                    {/* Legacy Build Options */}
                    {product.hasBuildOptions && product.buildOptions && (
                        <>
                            <div class="divider__border"></div>
                            <BuildOptions options={product.buildOptions} />
                        </>
                    )}
                </>
            )}




{
                relatedProducts.length > 0 && (
                <div class="divider__border"></div>
                    <section class="section__product-detail-related-products">
                        <div class="section__product-detail-related-products-title">
                            <h2>Related Products</h2>
                        </div>
                        <div class="section__product-detail-related-products-cards">
                        {relatedProducts.map((product: any) => (
                            <Card
                                imageURL={product.imageUrl}
                                imageAlt={product.imageAlt}
                                href={`/products/${product.slug}`}
                                buttonLabel={product.title}
                                icon={true}
                                style="light"
                            />
                        ))}
                    </div>
                 
                    </section>
                )
            }

        <ContactBlock />
           </div>

    </body>
</BaseLayout>

<Footer />

<style>
    .link__prev-page-wrapper {
        grid-column: 2 / -2; /* âœ… Added: Position in grid */
        display: flex;
        margin-bottom: 3rem;
        margin-top: 3rem;
    }

    .link__prev-page-wrapper a {
        text-decoration: none;
        color: var(--pj_brand_blue);
    }

    .link__prev-page {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 0.5rem;
    }

    .section__product-wrapper {
        grid-column: 2 / -2; /* Span the content columns of page grid */
        display: flex;
        flex-direction: column;
        flex-flow: column-reverse;
        margin-bottom: 3rem;
        gap: 1rem;
    }

    .section__product-overview {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .section__product-cta-buttons {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .section__product-detail-image {
        display: flex;
        margin-bottom: 1rem;
    }

    .section__product-detail-image img {
        display: block;
        width: 100%;
        height: auto;
        grid-column: 2 / 1;
        border-radius: 0.25rem;
        max-height: 400px;
        object-fit: cover;
    }

    .section__product-performance-table {
        display: flex;
        flex-direction: column;
        grid-column: 2 / -2;
        margin-bottom: 5rem;
    }

    .section__product-detail-additional-specs-wrapper {
        display: grid;
        grid-template-columns: 1fr; /* Single column on mobile */
        grid-column: 2 / -2;
        gap: 6rem;
        margin-bottom: 5rem;
    }

    .section__product-detail-physical-specs,
    .section__product-detail-engine-specs {
        display: flex;
        flex-direction: column;
    }

    .section__product-detail-physical-specs-content,
    .section__product-detail-engine-specs-content {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .section__product-detail-related-products {
        display: flex;
        flex-direction: column;
        grid-column: 2 / -2;
        margin-bottom: 7.75rem;
    }

    .section__product-detail-build-options {
        display: grid;
        grid-column: 2 / -2;
        margin-bottom: 6rem;
    }

    .section__product-detail-related-products-title h2 {
    font-size: 1.5rem;
    font-weight: 450;
    color: var(--pj_blue_80);
    margin-bottom: 2rem;
  }


    .section__product-detail-related-products-cards {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
    }

    .divider__border {
        margin-bottom: 1rem;
        height: 100%;
    }

    @media screen and (min-width: 768px) {
        .link__prev-page-wrapper {
            display: flex;
            height: 100%;
            margin-bottom: 3rem;
            margin-top: 3rem;
            grid-column: 2 / -2;
        }

        .divider__border {
            grid-column: 2 /-2;
        }

        .section__product-wrapper {
            display: flex;
            flex-direction: column;
            flex-flow: column-reverse;
            grid-column: 2 / -2;
            margin-bottom: 8rem;
        }

        .section__applications-details {
            display: flex;
            flex: 1;
        }

        .section__applications-image {
            display: flex;
            flex: 1;
        }

        .section__product-performance-table {
            display: grid;
            grid-column: 2 / -2;
            margin-bottom: 6rem;
        }

        .section__product-detail-additional-specs-wrapper {
            grid-column: 2 / -2;
            grid-template-columns: 1fr 1fr; /* Two equal columns */
            gap: 6rem;
            align-items: start;;
        }

        .section__product-detail-build-options {
            display: grid;
            grid-column: 2 / -2;
        }

        .section__applications-recommended-products {
            display: grid;
            grid-template-columns: 1fr;
            grid-column: 2 / -2;
            margin-bottom: 6rem;
            gap: 1rem;
        }

        .section__product-detail-related-products-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 320px));
            justify-content: start;
            gap: 1.5rem;
            grid-column: 2 / -2;
            margin-bottom: 4rem;
        }
    }
    @media screen and (min-width: 1024px) {
        .link__prev-page-wrapper {
            grid-column: 3 / -3;
            margin-bottom: 5rem;
        }

        .section__product-wrapper {
            display: flex;
            flex-direction: row;
            grid-column: 3 / -3;
            gap: 4rem;
        }

        .product-title {
            display: flex;
            flex-direction: row;
            grid-column: 3 / -3;
        }

        .divider__border {
            grid-column: 3 /-3;
        }

        .section__product-performance-table {
            display: grid;
            grid-column: 3 / -3;
        }

        .section__product-detail-related-products {
            display: grid;
            grid-column: 3 / -3;
        }

        .section__product-detail-additional-specs-wrapper {
            grid-template-columns: 1fr 1fr; /* Two equal columns */
            grid-column: 3 / -3;
            gap: 8rem;
            margin-bottom: 6rem;
        }

        .section__product-detail-build-options {
            display: grid;
            grid-column: 3 / -3;
        }
    }
</style>
