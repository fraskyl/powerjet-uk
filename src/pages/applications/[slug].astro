---
// src/pages/applications/[slug].astro
// This creates individual pages for each application using dynamic routing

import "../../styles/global.css";
import { sanityClient } from "../../lib/sanity";
import { applicationSlugsQuery, applicationBySlugQuery } from "../../lib/queries";
import ApplicationDetailLayout from "../../layouts/ApplicationDetailLayout.astro";

// Generate static paths for all applications at build time
export async function getStaticPaths() {
    try {
        // Fetch all application slugs from Sanity
        const applications = await sanityClient.fetch(applicationSlugsQuery);
        console.log("✅ Generating paths for applications:", applications?.length || 0);

        // Create a path for each application
        return applications.map((app: any) => ({
            params: { slug: app.slug },
        }));
    } catch (error) {
        console.error("❌ Error generating application paths:", error);
        return [];
    }
}

// Get the slug from the URL
const { slug } = Astro.params;

// Fetch the specific application data
let application;
try {
    application = await sanityClient.fetch(applicationBySlugQuery, { slug });
    console.log("✅ Fetched application:", application?.title);
} catch (error) {
    console.error("❌ Error fetching application:", error);
}

// If no application found, you might want to redirect to 404
if (!application) {
    return Astro.redirect("/404");
}

// Set page title
const title = `${application.title} | Applications | Powerjet`;
---

<ApplicationDetailLayout 
    title={title}
    application={application}
/>