---
interface Props {
  imageUrl?: string;
  imageAlt?: string;
  images?: Array<{
    url: string;
    alt: string;
    caption?: string;
  }>;
}

const { imageUrl, imageAlt, images } = Astro.props;

// Determine if we have a gallery or single image
let galleryImages = images || [];

// Backwards compatibility: convert single image props to array format
if (galleryImages.length === 0 && imageUrl) {
  galleryImages = [{
    url: imageUrl,
    alt: imageAlt || "Product image"
  }];
}

// Check if we should show gallery controls
const isSingleImage = galleryImages.length === 1;
---

<div class="image-gallery" data-gallery={!isSingleImage}>
  {isSingleImage ? (
    <!-- Single image view -->
    <div class="image-gallery__single">
      <img src={galleryImages[0].url} alt={galleryImages[0].alt} />
    </div>
  ) : (
    <!-- Gallery view -->
    <div class="image-gallery__gallery">
      <!-- Main Image Display -->
      <div class="gallery-main">
        {galleryImages.map((image, index) => (
          <div 
            class="gallery-slide" 
            data-index={index}
            style={index === 0 ? "display: block;" : "display: none;"}
          >
            <img 
              src={image.url} 
              alt={image.alt}
              loading={index === 0 ? "eager" : "lazy"}
            />
            {image.caption && (
              <p class="image-caption">{image.caption}</p>
            )}
          </div>
        ))}
        
        <!-- Navigation Arrows -->
        <button 
          class="gallery-nav gallery-prev" 
          aria-label="Previous image"
          data-direction="prev"
        >
          <span class="material-symbols-outlined">chevron_left</span>
        </button>
        <button 
          class="gallery-nav gallery-next" 
          aria-label="Next image"
          data-direction="next"
        >
          <span class="material-symbols-outlined">chevron_right</span>
        </button>
      </div>
      
      <!-- Thumbnail Navigation -->
      <div class="gallery-thumbnails">
        {galleryImages.map((image, index) => (
          <button
            class={`thumbnail ${index === 0 ? 'active' : ''}`}
            data-index={index}
            aria-label={`View image ${index + 1}`}
          >
            <img 
              src={image.url} 
              alt={image.alt}
              loading="lazy"
            />
          </button>
        ))}
      </div>
      
      <!-- Dot Navigation (Mobile Only) -->
      <div class="gallery-dots">
        {galleryImages.map((image, index) => (
          <button
            class={`dot ${index === 0 ? 'active' : ''}`}
            data-index={index}
            aria-label={`View image ${index + 1}`}
          >
          </button>
        ))}
      </div>
    </div>
  )}
</div>

<style>
  /* Base container */
  .image-gallery {
    width: 100%;
    max-width:100%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Single image styles */
  .image-gallery__single {
    aspect-ratio: 3 / 2;
    overflow: hidden;
  }

  .image-gallery__single img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .image-gallery__gallery {
    width: 100%;
    max-width: 100%;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    min-height: 0; 
  }

  /* Main Gallery Container - Fixed size prevents text squashing */
  .gallery-main {
    position: relative;
    width: 100%;
    max-width: 100%;
    aspect-ratio: 3 / 2;
    overflow: hidden;
    background-color: var(--pj_blue_05);
  }

  /* Individual Slides */
  .gallery-slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
  }

  .gallery-slide[style*="display: block"] {
    opacity: 1;
  }

  .gallery-slide img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* Navigation Arrows - Hidden by default, shown on hover */
  .gallery-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background-color: rgba(255, 255, 255, 0.9);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    opacity: 0; /* Hidden by default */
    pointer-events: none; /* Don't interfere with clicks when hidden */
  }
  
  /* Show arrows on gallery hover */
  .gallery-main:hover .gallery-nav {
    opacity: 1;
    pointer-events: auto; /* Enable clicks when visible */
  }

  .gallery-nav:hover {
    background-color: white;
  }

  .gallery-nav:active {
    transform: translateY(-50%) scale(0.95);
  }

  .gallery-prev {
    left: 0.5rem;
  }

  .gallery-next {
    right: 0.5rem;
  }

  .gallery-nav .material-symbols-outlined {
    font-size: 1.5rem;
    color: var(--pj_brand_blue);
  }

  /* Thumbnail Navigation - HIDDEN ON MOBILE */
  .gallery-thumbnails {
    display: none; /* Hidden on mobile - use dots instead */
  }
  
  /* Dot Navigation - MOBILE ONLY */
  .gallery-dots {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 0;
  }
  
  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--pj_blue_30);
    border: none;
    padding: 0;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .dot:hover {
    background-color: var(--pj_blue_50);
    transform: scale(1.2);
  }
  
  .dot.active {
    background-color: var(--pj_brand_blue);
    width: 24px;
    border-radius: 4px;
  }
  
  /* Thumbnail styles - for desktop */
  .thumbnail {
    flex-shrink: 0; /* Prevent thumbnails from shrinking */
    width: 60px;
    height: 60px;
    min-width: 60px; /* Ensure minimum size */
    border: 2px solid transparent;
    overflow: hidden;
    cursor: pointer;
    padding: 0;
    background: none;
  }

  .thumbnail:hover {
    border-color: var(--pj_blue_40);
  }

  .thumbnail.active {
    border-color: var(--pj_brand_blue);
  }

  .thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* Responsive adjustments */
  @media screen and (min-width: 768px) {
    /* Show thumbnails, hide dots on tablet/desktop */
    .gallery-thumbnails {
      display: flex;
      gap: 0.75rem;
      overflow-x: auto; /* Allow horizontal scrolling */
      overflow-y: hidden; /* Prevent vertical overflow */
      padding: 1rem 0;
      max-width: 100%; /* Constrain to container width */
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: var(--pj_blue_30) var(--pj_blue_10);
      
      /* Limit visible area to ~5 thumbnails */
      /* 80px thumbnails + 0.75rem gap = ~420px for 5 thumbnails */
      max-width: 440px;
    }
    
    .gallery-thumbnails::-webkit-scrollbar {
      height: 6px;
    }

    .gallery-thumbnails::-webkit-scrollbar-track {
      background: var(--pj_blue_10);
      border-radius: 3px;
    }

    .gallery-thumbnails::-webkit-scrollbar-thumb {
      background: var(--pj_blue_30);
      border-radius: 3px;
    }
    
    .gallery-dots {
      display: none; /* Hide dots on tablet/desktop */
    }
    
    .gallery-nav {
      width: 48px;
      height: 48px;
    }

    .gallery-nav .material-symbols-outlined {
      font-size: 2rem;
    }

    .gallery-prev {
      left: 1rem;
    }

    .gallery-next {
      right: 1rem;
    }

    .thumbnail {
      width: 80px;
      height: 80px;
      min-width: 80px;
    }
  }

  @media screen and (min-width: 1024px) {
    .thumbnail {
      width: 100px;
      height: 100px;
      min-width: 100px;
    }
    
    /* Limit visible area to ~5 thumbnails on desktop */
    /* 100px thumbnails + 0.75rem gap = ~540px for 5 thumbnails */
    .gallery-thumbnails {
      max-width: 560px;
    }
    
    /* Ensure gallery doesn't cause horizontal scroll */
    .image-gallery__gallery,
    .gallery-main {
      max-width: 100%;
    }
  }
</style>

<script>
  // Gallery functionality
  function initImageGallery() {
    const galleries = document.querySelectorAll('.image-gallery__gallery');
    
    galleries.forEach(gallery => {
      const slides = gallery.querySelectorAll('.gallery-slide');
      const thumbnails = gallery.querySelectorAll('.thumbnail');
      const dots = gallery.querySelectorAll('.dot');
      const prevBtn = gallery.querySelector('.gallery-prev');
      const nextBtn = gallery.querySelector('.gallery-next');
      
      let currentIndex = 0;
      
      function showSlide(index: number) {
        // Handle wrap-around
        if (index < 0) index = slides.length - 1;
        if (index >= slides.length) index = 0;
        
        // Hide all slides
        slides.forEach((slide) => {
          (slide as HTMLElement).style.display = 'none';
        });
        
        // Remove active class from thumbnails and dots
        thumbnails.forEach(thumb => thumb.classList.remove('active'));
        dots.forEach(dot => dot.classList.remove('active'));
        
        // Show current slide
        (slides[index] as HTMLElement).style.display = 'block';
        
        // Highlight current thumbnail and dot
        thumbnails[index]?.classList.add('active');
        dots[index]?.classList.add('active');
        
        currentIndex = index;
        
        // Scroll thumbnail into view (desktop only)
        thumbnails[index]?.scrollIntoView({
          behavior: 'smooth',
          block: 'nearest',
          inline: 'center'
        });
      }
      
      // Previous button
      prevBtn?.addEventListener('click', () => {
        showSlide(currentIndex - 1);
      });
      
      // Next button
      nextBtn?.addEventListener('click', () => {
        showSlide(currentIndex + 1);
      });
      
      // Thumbnail clicks
      thumbnails.forEach((thumb, index) => {
        thumb.addEventListener('click', () => {
          showSlide(index);
        });
      });
      
      // Dot clicks
      dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
          showSlide(index);
        });
      });
      
      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') {
          showSlide(currentIndex - 1);
        } else if (e.key === 'ArrowRight') {
          showSlide(currentIndex + 1);
        }
      });
      
      // Touch swipe support
      let touchStartX = 0;
      let touchEndX = 0;
      
      gallery.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
      });
      
      gallery.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      });
      
      function handleSwipe() {
        const swipeThreshold = 50;
        if (touchEndX < touchStartX - swipeThreshold) {
          showSlide(currentIndex + 1); // Swipe left
        }
        if (touchEndX > touchStartX + swipeThreshold) {
          showSlide(currentIndex - 1); // Swipe right
        }
      }
    });
  }
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initImageGallery);
  
  // Re-initialize on Astro view transitions (if using)
  document.addEventListener('astro:page-load', initImageGallery);
</script>